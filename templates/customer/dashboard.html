{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <!-- Cart Icon Button -->
    <button class="btn btn-primary position-fixed" style="right: 20px; top: 80px; z-index: 1000;" 
            type="button" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas">
        <i class="bi bi-cart3"></i>
        {% if cart and cart.cart_items %}
            <span class="badge bg-danger">{{ cart.cart_items|length }}</span>
                {% endif %}
            </button>

    <!-- Products Section -->
    <div class="row">
        <div class="col-12">
            <!-- Popular Products Section -->
            <div class="mb-5">
                <h2 class="mb-4">
                    <i class="bi bi-star-fill text-warning"></i> Popular Products
                    <small class="text-muted fs-6 fw-normal">| Trending items you might like</small>
                </h2>
                <div class="row">
                    {% if products %}
                        {% set total_products = products|length %}
                        {% set indices = range(total_products)|list %}
                        {% set selected_indices = [] %}
                        {% for _ in range(3 if total_products >= 3 else total_products) %}
                            {% set random_index = range(indices|length)|random %}
                            {% set selected_index = indices.pop(random_index) %}
                            {% set _ = selected_indices.append(selected_index) %}
                        {% endfor %}
                        {% for index in selected_indices %}
                            {% set product = products[index] %}
                            <div class="col-md-4 mb-4">
                                <div class="card h-100 border-0 shadow-sm popular-product">
                                    <div class="position-absolute top-0 end-0 m-2">
                                        <span class="badge bg-danger">Popular</span>
                                    </div>
                                    {% if product.image_url %}
                                    <div class="product-image-wrapper">
                                        <img src="{{ product.image_url }}" class="card-img-top" alt="{{ product.name }}">
                                    </div>
                                    {% endif %}
                                    <div class="card-body">
                                        <h5 class="card-title">{{ product.name }}</h5>
                                        <p class="card-text text-muted">{{ product.description }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="h5 mb-0 text-primary">R{{ "%.2f"|format(product.price) }}</span>
                                            <button class="btn btn-primary" onclick="addToCart('{{ product.id }}')">
                                                <i class="bi bi-cart-plus"></i> Add to Cart
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            <!-- All Products Section -->
            <div>
                <h2 class="mb-4">
                    <i class="bi bi-grid"></i> All Products
                    <small class="text-muted fs-6 fw-normal">| Browse our complete collection</small>
                </h2>
            <div class="row">
                {% for product in products %}
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        {% if product.image_url %}
                            <div class="product-image-wrapper">
                        <img src="{{ product.image_url }}" class="card-img-top" alt="{{ product.name }}">
                            </div>
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title">{{ product.name }}</h5>
                            <p class="card-text">{{ product.description }}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="h5 mb-0">R{{ "%.2f"|format(product.price) }}</span>
                                    <button class="btn btn-primary" onclick="addToCart('{{ product.id }}')">
                                <i class="bi bi-cart-plus"></i> Add to Cart
                            </button>
                                </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cart Offcanvas -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title">
            <i class="bi bi-cart3"></i> Your Cart
            {% if cart and cart.cart_items %}
            <span class="badge bg-primary rounded-pill ms-2">{{ cart.cart_items|length }}</span>
            {% endif %}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        {% if cart and cart.cart_items %}
        <div class="cart-items-container mb-3">
            {% for item in cart.cart_items %}
            <div class="card mb-3 cart-item shadow-sm" data-product-id="{{ item.product_id }}">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        {% if item.image_url %}
                        <img src="{{ item.image_url }}" class="rounded me-3" style="width: 80px; height: 80px; object-fit: cover;">
                        {% endif %}
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="mb-1">{{ item.name }}</h6>
                                <button class="btn btn-link text-danger p-0" onclick="removeFromCart('{{ item.product_id }}')">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                        </div>
                            <p class="mb-2 text-muted item-price" data-price="{{ item.price }}">
                                R{{ "%.2f"|format(item.price) }} each
                            </p>
                            <div class="d-flex align-items-center">
                                <div class="input-group input-group-sm" style="width: 120px;">
                                    <button class="btn btn-outline-primary decrease-quantity">
                                        <i class="bi bi-dash"></i>
                                    </button>
                            <input type="number" class="form-control quantity-input" 
                                   value="{{ item.quantity }}" min="1" style="text-align: center;">
                                    <button class="btn btn-outline-primary increase-quantity">
                                        <i class="bi bi-plus"></i>
                        </button>
                                </div>
                                <span class="ms-3 text-primary fw-bold">
                                    R{{ "%.2f"|format(item.price * item.quantity) }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
            
        <div class="cart-summary bg-light rounded p-3 mb-3">
            <div class="d-flex justify-content-between mb-2">
                <span>Subtotal</span>
                <span>R{{ "%.2f"|format(cart.total) }}</span>
                    </div>
            <div class="d-flex justify-content-between mb-2">
                <span>Tax (15%)</span>
                <span>R{{ "%.2f"|format(cart.total * 0.15) }}</span>
            </div>
            <div class="d-flex justify-content-between fw-bold">
                <span>Total</span>
                <span>R<span id="cartTotal">{{ "%.2f"|format(cart.total * 1.15) }}</span></span>
                </div>
            </div>

        <div class="d-grid gap-2">
            <button class="btn btn-primary" onclick="proceedToCheckout()">
                <i class="bi bi-bag-check"></i> Proceed to Checkout
            </button>
            <button class="btn btn-outline-primary" data-bs-dismiss="offcanvas">
                <i class="bi bi-arrow-left"></i> Continue Shopping
            </button>
        </div>
        {% else %}
            <div class="text-center py-5">
            <div class="empty-cart-illustration mb-4">
                <i class="bi bi-cart3 display-1 text-muted"></i>
            </div>
            <h5 class="mb-3">Your cart is empty</h5>
            <p class="text-muted mb-4">Looks like you haven't added any items yet.</p>
            <button class="btn btn-primary" data-bs-dismiss="offcanvas">
                <i class="bi bi-arrow-left"></i> Start Shopping
            </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<!-- Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-bag-check"></i> Checkout
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('place_order') }}" method="POST" id="checkoutForm">
                    <!-- Cart Summary -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">Order Summary</h6>
                            {% if cart and cart.cart_items %}
                                {% for item in cart.cart_items %}
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <input type="hidden" name="items" value="{{ item.product_id }}">
                                        <span>{{ item.name }} × {{ item.quantity }}</span>
                                    </div>
                                    <span>R{{ "%.2f"|format(item.price * item.quantity) }}</span>
                                </div>
                                    {% endfor %}
                                <hr>
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong>Total:</strong>
                                    <strong>R{{ "%.2f"|format(cart.total) }}</strong>
                                </div>
                                <input type="hidden" name="total" value="{{ cart.total }}">
                            {% endif %}
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <select class="form-select" name="payment_method" id="paymentMethod" required>
                            <option value="">Select payment method</option>
                            <option value="manual">Manual Payment (Upload Proof)</option>
                            <option value="gateway">Pay Online (Credit/Debit Card)</option>
                        </select>
                    </div>

                    <!-- Manual Payment Section -->
                    <div id="manualPaymentSection" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Proof of Payment</label>
                            <input type="file" class="form-control" name="proof_of_payment" id="proofOfPayment" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg">
                            <small class="text-muted">
                                Accepted formats: PDF, Word documents (DOC/DOCX), Images (PNG/JPG)
                            </small>
                        </div>
                    </div>

                    <!-- Online Payment Section -->
                    <div id="onlinePaymentSection" style="display: none;">
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0">Card Number</label>
                                        <div class="card-brands">
                                            <img src="https://img.icons8.com/color/48/000000/visa.png" class="card-brand-icon" id="visaIcon" style="opacity: 0.3; height: 24px;">
                                            <img src="https://img.icons8.com/color/48/000000/mastercard.png" class="card-brand-icon" id="mastercardIcon" style="opacity: 0.3; height: 24px;">
                                            <img src="https://img.icons8.com/color/48/000000/amex.png" class="card-brand-icon" id="amexIcon" style="opacity: 0.3; height: 24px;">
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-credit-card"></i>
                                        </span>
                                        <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Expiry Date</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="bi bi-calendar"></i>
                                            </span>
                                            <input type="text" class="form-control" id="cardExpiry" placeholder="MM/YY" maxlength="5">
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">CVV</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="bi bi-lock"></i>
                                            </span>
                                            <input type="password" class="form-control" id="cardCvv" placeholder="123" maxlength="3">
                                            <button class="btn btn-outline-secondary" type="button" id="toggleCvv">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Cardholder Name</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-person"></i>
                                        </span>
                                        <input type="text" class="form-control" id="cardholderName" placeholder="John Doe">
                                    </div>
                                </div>
                                <div class="payment-card-preview mt-4">
                                    <div class="card bg-primary text-white" style="border-radius: 15px;">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <img src="https://img.icons8.com/color/48/000000/chip-card.png" style="height: 40px;">
                                                <span id="previewCardBrand"></span>
                                            </div>
                                            <div class="card-number mb-3" id="previewCardNumber">•••• •••• •••• ••••</div>
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <small class="d-block text-uppercase">Card Holder</small>
                                                    <div id="previewCardHolder">JOHN DOE</div>
                                                </div>
                                                <div class="text-end">
                                                    <small class="d-block text-uppercase">Expires</small>
                                                    <div id="previewCardExpiry">MM/YY</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Method -->
                            <div class="mb-3">
                                <label class="form-label">Delivery Method</label>
                        <select class="form-select" name="delivery_method" id="deliveryMethod" required>
                                    <option value="pickup">Pickup</option>
                                    <option value="delivery">Delivery</option>
                                </select>
                            </div>

                    <!-- Delivery Date Selection -->
                    <div class="mb-3" id="deliveryDateSection" style="display: none;">
                        <label class="form-label">Delivery Date</label>
                        <div class="card">
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-check delivery-option">
                                            <input class="form-check-input" type="radio" name="delivery_speed" 
                                                   id="expressDelivery" value="express">
                                            <label class="form-check-label" for="expressDelivery">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>Express Delivery</strong>
                                                        <div class="text-success">Next Business Day</div>
                                                        <small class="text-muted">Guaranteed delivery by tomorrow</small>
                                                    </div>
                                                    <span class="badge bg-success">+R150</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check delivery-option">
                                            <input class="form-check-input" type="radio" name="delivery_speed" 
                                                   id="standardDelivery" value="standard">
                                            <label class="form-check-label" for="standardDelivery">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>Standard Delivery</strong>
                                                        <div class="text-primary">2-3 Business Days</div>
                                                        <small class="text-muted">Regular delivery time</small>
                                                    </div>
                                                    <span class="badge bg-primary">+R50</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check delivery-option">
                                            <input class="form-check-input" type="radio" name="delivery_speed" 
                                                   id="flexibleDelivery" value="flexible" checked>
                                            <label class="form-check-label" for="flexibleDelivery">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>Flexible Delivery</strong>
                                                        <div class="text-muted">Choose Your Date</div>
                                                        <small class="text-muted">Select a preferred date</small>
                                                    </div>
                                                    <span class="badge bg-secondary">Standard Rate</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check delivery-option">
                                            <input class="form-check-input" type="radio" name="delivery_speed" 
                                                   id="economyDelivery" value="economy">
                                            <label class="form-check-label" for="economyDelivery">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>Economy Delivery</strong>
                                                        <div class="text-info">5-7 Business Days</div>
                                                        <small class="text-muted">Budget-friendly option</small>
                                                    </div>
                                                    <span class="badge bg-info">-R20</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Custom Date Selection (for Flexible Delivery) -->
                                <div id="customDateSection" class="mt-3">
                                    <label class="form-label">Select Preferred Date</label>
                                    <input type="date" class="form-control" name="preferred_delivery_date" id="preferredDate">
                                    <small class="text-muted">
                                        Choose any date within the next 30 days
                                    </small>
                                </div>
                            </div>
                        </div>
                            </div>

                    <!-- Delivery Details (hidden by default) -->
                            <div id="deliveryDetails" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" name="customer_name">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Age</label>
                            <input type="number" class="form-control" name="customer_age">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Gender</label>
                            <select class="form-select" name="customer_gender">
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Delivery Address</label>
                            <textarea class="form-control" name="delivery_address" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Contact Number</label>
                            <input type="tel" class="form-control" name="contact_number">
                                </div>
                    </div>

                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-bag-check"></i> Place Order
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize cart total
    updateCartTotal();

    // Quantity controls with debounce
    let updateTimeout;
    
    document.querySelectorAll('.decrease-quantity').forEach(button => {
        button.addEventListener('click', function() {
            const input = this.parentElement.querySelector('.quantity-input');
            const productId = this.closest('.cart-item').dataset.productId;
            if (input.value > 1) {
                input.value = parseInt(input.value) - 1;
                debouncedUpdateQuantity(productId, input.value, this.closest('.cart-item'));
            }
        });
    });

    document.querySelectorAll('.increase-quantity').forEach(button => {
        button.addEventListener('click', function() {
            const input = this.parentElement.querySelector('.quantity-input');
            const productId = this.closest('.cart-item').dataset.productId;
            input.value = parseInt(input.value) + 1;
            debouncedUpdateQuantity(productId, input.value, this.closest('.cart-item'));
        });
    });

    // Handle manual quantity input
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('change', function() {
            const productId = this.closest('.cart-item').dataset.productId;
            if (this.value < 1) this.value = 1;
            debouncedUpdateQuantity(productId, this.value, this.closest('.cart-item'));
        });
        
        // Prevent non-numeric input
        input.addEventListener('keypress', function(e) {
            if (!/[0-9]/.test(e.key)) {
                e.preventDefault();
            }
        });
    });

    // Debounced update function
    function debouncedUpdateQuantity(productId, quantity, cartItem) {
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(() => {
            updateCartQuantity(productId, quantity, cartItem);
        }, 500);
    }

    // Add delivery method change handler
    document.getElementById('deliveryMethod').addEventListener('change', function() {
        const deliveryDetails = document.getElementById('deliveryDetails');
        const deliveryDateSection = document.getElementById('deliveryDateSection');
        const deliveryInputs = deliveryDetails.querySelectorAll('input, select, textarea');
        
        if (this.value === 'delivery') {
            deliveryDetails.style.display = 'block';
            deliveryDateSection.style.display = 'block';
            deliveryInputs.forEach(input => input.required = true);
            setupDeliveryDateOptions();
        } else {
            deliveryDetails.style.display = 'none';
            deliveryDateSection.style.display = 'none';
            deliveryInputs.forEach(input => input.required = false);
        }
    });

    // Add form submission handler
    const checkoutForm = document.querySelector('#checkoutModal form');
    if (checkoutForm) {
        checkoutForm.addEventListener('submit', handleCheckoutSubmission);
    }

    // Add file size validation
    document.getElementById('proofOfPayment').addEventListener('change', validateFileUpload);

    // Add payment method change handler
    document.getElementById('paymentMethod').addEventListener('change', function() {
        const manualSection = document.getElementById('manualPaymentSection');
        const onlineSection = document.getElementById('onlinePaymentSection');
        const proofOfPayment = document.getElementById('proofOfPayment');
        const cardInputs = onlineSection.querySelectorAll('input');
        
        if (this.value === 'manual') {
            manualSection.style.display = 'block';
            onlineSection.style.display = 'none';
            proofOfPayment.required = true;
            cardInputs.forEach(input => input.required = false);
        } else if (this.value === 'gateway') {
            manualSection.style.display = 'none';
            onlineSection.style.display = 'block';
            proofOfPayment.required = false;
            cardInputs.forEach(input => input.required = true);
        } else {
            manualSection.style.display = 'none';
            onlineSection.style.display = 'none';
            proofOfPayment.required = false;
            cardInputs.forEach(input => input.required = false);
        }
    });

    // Format card number input
    document.getElementById('cardNumber').addEventListener('input', function(e) {
        let value = this.value.replace(/\D/g, '');
        if (value.length > 16) value = value.slice(0, 16);
        let formattedValue = '';
        for (let i = 0; i < value.length; i++) {
            if (i > 0 && i % 4 === 0) formattedValue += ' ';
            formattedValue += value[i];
        }
        this.value = formattedValue;
    });

    // Format expiry date input
    document.getElementById('cardExpiry').addEventListener('input', function(e) {
        let value = this.value.replace(/\D/g, '');
        if (value.length > 4) value = value.slice(0, 4);
        if (value.length > 2) {
            value = value.slice(0, 2) + '/' + value.slice(2);
        }
        this.value = value;
    });

    // Format CVV input
    document.getElementById('cardCvv').addEventListener('input', function(e) {
        let value = this.value.replace(/\D/g, '');
        if (value.length > 3) value = value.slice(0, 3);
        this.value = value;
    });

    // Toggle CVV visibility
    document.getElementById('toggleCvv').addEventListener('click', function() {
        const cvvInput = document.getElementById('cardCvv');
        const icon = this.querySelector('i');
        if (cvvInput.type === 'password') {
            cvvInput.type = 'text';
            icon.classList.replace('bi-eye', 'bi-eye-slash');
        } else {
            cvvInput.type = 'password';
            icon.classList.replace('bi-eye-slash', 'bi-eye');
        }
    });

    // Card number preview and brand detection
    document.getElementById('cardNumber').addEventListener('input', function(e) {
        let value = this.value.replace(/\D/g, '');
        if (value.length > 16) value = value.slice(0, 16);
        let formattedValue = '';
        for (let i = 0; i < value.length; i++) {
            if (i > 0 && i % 4 === 0) formattedValue += ' ';
            formattedValue += value[i];
        }
        this.value = formattedValue;
        
        // Update preview
        const previewNumber = document.getElementById('previewCardNumber');
        previewNumber.textContent = formattedValue || '•••• •••• •••• ••••';
        
        // Detect card brand
        const firstDigit = value.charAt(0);
        const firstTwoDigits = value.substring(0, 2);
        
        // Reset all icons
        document.querySelectorAll('.card-brand-icon').forEach(icon => icon.style.opacity = '0.3');
        
        if (value.length > 0) {
            if (firstDigit === '4') {
                document.getElementById('visaIcon').style.opacity = '1';
                document.getElementById('previewCardBrand').innerHTML = '<img src="https://img.icons8.com/color/48/000000/visa.png" style="height: 30px;">';
            } else if (firstTwoDigits >= '51' && firstTwoDigits <= '55') {
                document.getElementById('mastercardIcon').style.opacity = '1';
                document.getElementById('previewCardBrand').innerHTML = '<img src="https://img.icons8.com/color/48/000000/mastercard.png" style="height: 30px;">';
            } else if (firstTwoDigits === '34' || firstTwoDigits === '37') {
                document.getElementById('amexIcon').style.opacity = '1';
                document.getElementById('previewCardBrand').innerHTML = '<img src="https://img.icons8.com/color/48/000000/amex.png" style="height: 30px;">';
            }
        } else {
            document.getElementById('previewCardBrand').innerHTML = '';
        }
    });

    // Cardholder name preview
    document.getElementById('cardholderName').addEventListener('input', function() {
        const previewHolder = document.getElementById('previewCardHolder');
        previewHolder.textContent = this.value.toUpperCase() || 'JOHN DOE';
    });

    // Expiry date preview
    document.getElementById('cardExpiry').addEventListener('input', function() {
        const previewExpiry = document.getElementById('previewCardExpiry');
        previewExpiry.textContent = this.value || 'MM/YY';
    });

    // Setup delivery date options
    function setupDeliveryDateOptions() {
        const today = new Date();
        const preferredDate = document.getElementById('preferredDate');
        const minDate = new Date(today);
        const maxDate = new Date(today);
        maxDate.setDate(today.getDate() + 30);

        preferredDate.min = minDate.toISOString().split('T')[0];
        preferredDate.max = maxDate.toISOString().split('T')[0];

        // Set default date based on selected delivery speed
        updateDefaultDate();
    }

    // Handle delivery speed selection
    document.querySelectorAll('input[name="delivery_speed"]').forEach(radio => {
        radio.addEventListener('change', function() {
            // Update selected styles
            document.querySelectorAll('.delivery-option').forEach(option => {
                option.classList.remove('selected');
            });
            this.closest('.delivery-option').classList.add('selected');

            // Show/hide custom date section
            const customDateSection = document.getElementById('customDateSection');
            customDateSection.style.display = this.value === 'flexible' ? 'block' : 'none';

            // Update default date based on selection
            updateDefaultDate();

            // Update total price
            updateTotalWithDelivery();
        });
    });

    function updateDefaultDate() {
        const today = new Date();
        const preferredDate = document.getElementById('preferredDate');
        const selectedSpeed = document.querySelector('input[name="delivery_speed"]:checked').value;

        let deliveryDate = new Date(today);
        switch (selectedSpeed) {
            case 'express':
                deliveryDate.setDate(today.getDate() + 1);
                break;
            case 'standard':
                deliveryDate.setDate(today.getDate() + 3);
                break;
            case 'economy':
                deliveryDate.setDate(today.getDate() + 7);
                break;
            case 'flexible':
                // Don't set a default date for flexible delivery
                return;
        }

        if (selectedSpeed !== 'flexible') {
            preferredDate.value = deliveryDate.toISOString().split('T')[0];
        }
    }

    function updateTotalWithDelivery() {
        const selectedSpeed = document.querySelector('input[name="delivery_speed"]:checked').value;
        const currentTotal = parseFloat(document.getElementById('cartTotal').textContent);
        let deliveryCharge = 0;

        switch (selectedSpeed) {
            case 'express':
                deliveryCharge = 150;
                break;
            case 'standard':
                deliveryCharge = 50;
                break;
            case 'economy':
                deliveryCharge = -20;
                break;
        }

        const newTotal = currentTotal + deliveryCharge;
        document.getElementById('finalTotal').textContent = newTotal.toFixed(2);
    }

    // Initialize delivery options
    const firstDeliveryOption = document.querySelector('.delivery-option');
    if (firstDeliveryOption) {
        firstDeliveryOption.classList.add('selected');
    }
});

async function handleCheckoutSubmission(e) {
            e.preventDefault();
            
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

    try {
        const paymentMethod = document.getElementById('paymentMethod').value;
        
        if (paymentMethod === 'gateway') {
            // Simulate payment processing
            await processDummyPayment();
        }

            // Get form data
            const formData = new FormData(this);
            
        // Handle file upload for manual payment
        if (paymentMethod === 'manual') {
            const fileInput = document.getElementById('proofOfPayment');
            const file = fileInput.files[0];
            
            if (file) {
                const base64File = await convertFileToBase64(file);
                formData.append('proof_of_payment_data', base64File);
                formData.append('file_type', file.type);
                formData.append('file_name', file.name);
            }
            }

            // Submit order
        const response = await fetch(this.action, {
                method: 'POST',
                body: formData
        });

                if (response.redirected) {
                    window.location.href = response.url;
                } else {
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error || 'Error placing order');
            }
            
            // Show success message and redirect
            showToast('Success', 'Order placed successfully!', 'success');
            setTimeout(() => {
                window.location.href = '/orders';
            }, 2000);
        }
    } catch (error) {
                console.error('Error:', error);
        showToast('Error', error.message || 'Error placing order', 'error');
    } finally {
                submitButton.disabled = false;
        submitButton.innerHTML = '<i class="bi bi-bag-check"></i> Place Order';
    }
}

function validateFileUpload(e) {
        const file = e.target.files[0];
        const maxSize = 5 * 1024 * 1024; // 5MB max size
        
        if (file.size > maxSize) {
            showToast('Error', 'File size must be less than 5MB', 'error');
        this.value = '';
            return;
        }
        
        const validTypes = ['application/pdf', 'application/msword', 
                           'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                           'image/jpeg', 'image/png'];
                           
        if (!validTypes.includes(file.type)) {
            showToast('Error', 'Invalid file type. Please upload PDF, DOC, DOCX, or images only', 'error');
        this.value = '';
        }
        }

function updateCartTotal() {
    const cartItems = document.querySelectorAll('.cart-item');
    let subtotal = 0;

    cartItems.forEach(item => {
        const price = parseFloat(item.querySelector('.item-price').dataset.price);
        const quantity = parseInt(item.querySelector('.quantity-input').value);
        subtotal += price * quantity;
    });

    const tax = subtotal * 0.15;
    const total = subtotal + tax;

    // Update all totals
    document.getElementById('cartTotal').textContent = total.toFixed(2);
    updateCartBadge(cartItems.length);
}

function updateCartBadge(itemCount) {
    const badges = document.querySelectorAll('.badge');
    badges.forEach(badge => {
        if (itemCount > 0) {
            badge.textContent = itemCount;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
    });
}

function addToCart(productId) {
    const button = event.target.closest('button');
    button.disabled = true;
    const originalContent = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Adding...';

    fetch(`/cart/add/${productId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Success', 'Item added to cart', 'success');
            if (data.cart) {
                location.reload(); // Refresh to update cart state
            }
        } else {
            throw new Error(data.error || 'Error adding to cart');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error', error.message || 'Error adding to cart', 'error');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = originalContent;
    });
}

function updateCartQuantity(productId, quantity, cartItem) {
    const loadingOverlay = createLoadingOverlay();
    cartItem.appendChild(loadingOverlay);

    fetch(`/cart/update/${productId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ quantity: quantity })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const price = parseFloat(cartItem.querySelector('.item-price').dataset.price);
            const subtotal = price * quantity;
            cartItem.querySelector('.text-primary.fw-bold').textContent = `R${subtotal.toFixed(2)}`;
            updateCartTotal();
        } else {
            throw new Error(data.error || 'Error updating quantity');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error', error.message || 'Error updating quantity', 'error');
    })
    .finally(() => {
        loadingOverlay.remove();
    });
}

function removeFromCart(productId) {
    const cartItem = document.querySelector(`.cart-item[data-product-id="${productId}"]`);
    
    // Add fade-out animation
    cartItem.style.transition = 'all 0.3s ease';
    cartItem.style.opacity = '0';
    cartItem.style.transform = 'translateX(100px)';

    fetch(`/cart/remove/${productId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            setTimeout(() => {
            cartItem.remove();
            updateCartTotal();
            
            // Check if cart is empty
            const cartItems = document.querySelectorAll('.cart-item');
            if (cartItems.length === 0) {
                    location.reload(); // Refresh to show empty cart state
            }
            }, 300);
            
            showToast('Success', 'Item removed from cart', 'success');
        } else {
            throw new Error(data.error || 'Error removing item');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error', error.message || 'Error removing item', 'error');
        // Restore item visibility on error
        cartItem.style.opacity = '1';
        cartItem.style.transform = 'none';
    });
}

function createLoadingOverlay() {
    const overlay = document.createElement('div');
    overlay.className = 'position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-75';
    overlay.innerHTML = '<div class="spinner-border text-primary"></div>';
    overlay.style.zIndex = '1000';
    return overlay;
}

function showToast(title, message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : 'success'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <strong>${title}:</strong> ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    container.style.zIndex = '1060';
    document.body.appendChild(container);
    return container;
}

function convertFileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

function proceedToCheckout() {
    // Reset form state
    const checkoutForm = document.querySelector('#checkoutModal form');
    checkoutForm.reset();
    
    // Reset delivery details
    const deliveryDetails = document.getElementById('deliveryDetails');
    const deliveryInputs = deliveryDetails.querySelectorAll('input, select, textarea');
    deliveryInputs.forEach(input => {
        input.value = '';
        input.required = false;
    });
    deliveryDetails.style.display = 'none';
    
    // Reset delivery method
    document.getElementById('deliveryMethod').value = 'pickup';
    
    // Reset file input
    document.getElementById('proofOfPayment').value = '';
    
    // Update order summary with current cart items
    updateOrderSummary();
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('checkoutModal'));
    modal.show();
}

function updateOrderSummary() {
    const cartItems = document.querySelectorAll('.cart-item');
    const orderSummaryContainer = document.querySelector('#checkoutModal .card-body');
    let summaryHTML = '<h6 class="card-title">Order Summary</h6>';
    let total = 0;

    cartItems.forEach(item => {
        const name = item.querySelector('h6').textContent;
        const price = parseFloat(item.querySelector('.item-price').dataset.price);
        const quantity = parseInt(item.querySelector('.quantity-input').value);
        const subtotal = price * quantity;
        total += subtotal;

        summaryHTML += `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <input type="hidden" name="items" value="${item.dataset.productId}">
                    <span>${name} × ${quantity}</span>
                </div>
                <span>R${subtotal.toFixed(2)}</span>
            </div>
        `;
    });

    const tax = total * 0.15;
    const finalTotal = total + tax;

    summaryHTML += `
        <hr>
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span>Subtotal</span>
            <span>R${total.toFixed(2)}</span>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span>Tax (15%)</span>
            <span>R${tax.toFixed(2)}</span>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <strong>Total:</strong>
            <strong>R${finalTotal.toFixed(2)}</strong>
        </div>
        <input type="hidden" name="total" value="${finalTotal.toFixed(2)}">
    `;

    orderSummaryContainer.innerHTML = summaryHTML;
}

function processDummyPayment() {
    return new Promise((resolve, reject) => {
        // Show processing message
        showToast('Info', 'Processing payment...', 'info');
        
        // Simulate payment processing delay
        setTimeout(() => {
            // Validate card details
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const cardExpiry = document.getElementById('cardExpiry').value;
            const cardCvv = document.getElementById('cardCvv').value;
            const cardholderName = document.getElementById('cardholderName').value;
            
            if (!cardNumber || !cardExpiry || !cardCvv || !cardholderName) {
                reject(new Error('Please fill in all card details'));
                return;
            }
            
            if (cardNumber.length !== 16) {
                reject(new Error('Invalid card number'));
                return;
            }
            
            if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
                reject(new Error('Invalid expiry date format (MM/YY)'));
                return;
            }
            
            if (cardCvv.length !== 3) {
                reject(new Error('Invalid CVV'));
                return;
            }
            
            // Simulate successful payment
            showToast('Success', 'Payment processed successfully!', 'success');
            resolve();
        }, 2000);
    });
}
</script>

<style>
.cart-item {
    position: relative;
}

.toast-container {
    z-index: 1050;
}

.payment-card-preview .card {
    background: linear-gradient(135deg, #0d6efd, #0a58ca);
    transition: all 0.3s ease;
}

.payment-card-preview .card-number {
    font-size: 1.4em;
    letter-spacing: 2px;
}

.card-brand-icon {
    margin-left: 8px;
    transition: opacity 0.3s ease;
}

.input-group-text {
    background-color: #f8f9fa;
}

#cardNumber, #cardExpiry, #cardCvv, #cardholderName {
    font-family: 'Courier New', monospace;
}

.payment-card-preview small {
    opacity: 0.8;
    font-size: 0.7em;
}

.payment-card-preview #previewCardHolder,
.payment-card-preview #previewCardExpiry {
    font-size: 0.9em;
    letter-spacing: 1px;
}

.delivery-option {
    padding: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.delivery-option:hover {
    background-color: #f8f9fa;
    border-color: #0d6efd;
}

.delivery-option .form-check-input {
    margin-top: 1.5rem;
}

.delivery-option .form-check-label {
    width: 100%;
    cursor: pointer;
}

.delivery-option.selected {
    border-color: #0d6efd;
    background-color: #f8f9fa;
    box-shadow: 0 0 0 1px #0d6efd;
}

#customDateSection {
    border-top: 1px solid #dee2e6;
    padding-top: 1rem;
    margin-top: 1rem;
}

#preferredDate {
    max-width: 200px;
}

.popular-product {
    transform: translateY(0);
    transition: all 0.3s ease;
}

.popular-product:hover {
    transform: translateY(-10px);
}

.product-image-wrapper {
    height: 200px;
    overflow: hidden;
}

.product-image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.card:hover .product-image-wrapper img {
    transform: scale(1.1);
}

.badge {
    z-index: 2;
}

/* Animated background for popular products */
.popular-product {
    background: linear-gradient(45deg, #ffffff 25%, #f8f9fa 25%, #f8f9fa 50%, #ffffff 50%, #ffffff 75%, #f8f9fa 75%, #f8f9fa);
    background-size: 20px 20px;
    animation: moveBackground 30s linear infinite;
}

@keyframes moveBackground {
    0% {
        background-position: 0 0;
    }
    100% {
        background-position: 40px 40px;
    }
}
</style>
{% endblock %} 